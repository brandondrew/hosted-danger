shared:
  image: cd.docker-registry.corp.yahoo.co.jp:4443/approduce/hosted-danger-sd-image:latest
  environment:
    PCF_DEV01_API: https://api.system.dev01.ssk.cfm.yahoo.co.jp
    PCF_DEV01_ORG: approduce
    PCF_DEV01_USER: dev01_approduce_dev-approduce
    PCF_DEV01_SPACE: dev-approduce
    PCF_DEV01_DOMAIN: approduce.dev01.ssk.cfm.yahoo.co.jp

jobs:

  pr:
    requires: [~pr]
    steps:
      - format: |
          crystal tool format --check &> /dev/null
          ret_code=$?

          if [ 0 -ne $ret_code ]; then
              echo 'Please formatting the codes. ('$ret_code')'
              exit $ret_code
          else
              echo 'Success!'
          fi
      - build: |
          shards build
      - test: |
          crystal spec

  commit:
    requires: [~commit]
    steps:
      - build: |
          shards build
      - test: |
          crystal spec

  release:
    requires: [commit]
    steps:
      - build: |
          shards build
      - cf-login: |
          cf login --skip-ssl-validation \
          -a "$PCF_DEV01_API" \
          -o "$PCF_DEV01_ORG" \
          -s "$PCF_DEV01_SPACE" \
          -u "$PCF_DEV01_USER" \
          -p "$PCF_DEV01_PW"
      - cf-push: |
          cf push
    secrets:
      - PCF_DEV01_PW
